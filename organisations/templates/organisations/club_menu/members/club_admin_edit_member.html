{#------------------------------------------------------------------------#}
{#                                                                        #}
{#  Club Admin - Edit Member Page                                         #}
{#                                                                        #}
{#------------------------------------------------------------------------#}
{% extends 'base.html' %}
{% load static %}
{% load cobalt_tags %}
{% load widget_tweaks %}
{% load crispy_forms_tags %}

{% block title %} - Edit Member{% endblock %}

{% block header %}
    {% include "utils/summernote_heading.html" %}
{% endblock header %}

{% block content %}

    <!-- MAIN CARD ON PAGE -->

    <div class="card">

        <!-- CARD HEADER -->
        <div class="card-header card-header-info">
            <h1>
                <div class="d-flex justify-content-between">
                    <div>
                        Edit Member
                    </div>
                    <!-- DONT SHOW ICON ON SMALL SCREENS - OVERLAPS -->
                    <div class="d-none d-md-inline">
                        <i class="material-icons" style="font-size:50px">manage_accounts</i>
                    </div>
                </div>
            </h1>
            <h2>
                {{ member_details.first_name }} {{ member_details.last_name }} - {{ GLOBAL_ORG }}:{{ member_details.system_number }} ({{ club }})
            </h2>
        </div>

        <!-- CARD BODY -->
        <div class="container">
            <div class="card-body">

                <!-- MEMBERSHIP DETAILS -->

                <div class="card mt-5">
                    <div class="card-header card-header-warning">
                        Membership Details
                    </div>
                    <div class="container">
                        <div class="card-body">

                            {% if message %}
                                <div class="row justify-content-center">
                                    <div class="col-auto">
                                        <h3 class="text-danger">{{ message }}</h3>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- MEMBERSHIP HISTORY TABLE -->

                            <div class="table-responsive">
                                <table class="table table-condensed table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-left">Start Date</th>
                                            <th class="text-left">Membership Type</th>
                                            <th class="text-left">Membership Status</th>
                                            <th class="text-left">End Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for mmt in member_history %}
                                            <tr
                                                {% if forloop.first %}
                                                    class="font-weight-bold"
                                                {% else %}
                                                    class="text-muted"
                                                {% endif %}
                                            >
                                                <td class="text-left">{{ mmt.start_date }}</td>
                                                <td class="text-left">{{ mmt.membership_type.name }}</td>
                                                <td class="text-left">{{ mmt.get_membership_state_display }}</td>
                                                <td class="text-left">
                                                    {% if mmt.membership_state == 'CUR' %}
                                                        {% if paid_until_date %}
                                                            Paid until {{ mmt.paid_until_date }}
                                                        {% else %}
                                                            Perpetual
                                                        {% endif %}
                                                    {% elif membership_details.membership_status == 'DUE' %}
                                                        Paid until {{ mmt.paid_until_date }}
                                                        , {{ mmt.fee }} due by {{mmt.due_date }}
                                                    {% else %}
                                                        {{ mmt.end_date }}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- ACTION BUTTONS -->

                            <div class="row">
                                <div class="col">

                                    {% if member_details.membership_status == 'DEC' %}

                                        <h3 class="text-danger">This member has been marked as deceased. No updates are permitted</h3>

                                    {% else %}

                                        <!-- CHANGE STATUS DROPDOWN -->

                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                Change Status
                                            </button>
                                            <div class="dropdown-menu">
                                                {% if member_details.membership_status == 'CUR' or member_details.membership_status == 'DUE' %}
                                                    <a
                                                        class="btn btn-sm btn-secondary"
                                                        href="{% url 'organisations:club_admin_edit_member_lapsed' club_id=club.id system_number=member_details.system_number %}"
                                                    >
                                                        Lapsed
                                                    </a>
                                                    <a
                                                        class="btn btn-sm btn-secondary"
                                                        href="{% url 'organisations:club_admin_edit_member_resigned' club_id=club.id system_number=member_details.system_number %}"
                                                    >
                                                        Resigned
                                                    </a>
                                                    <a
                                                        class="btn btn-sm btn-secondary"
                                                        href="{% url 'organisations:club_admin_edit_member_terminate' club_id=club.id system_number=member_details.system_number %}"
                                                    >
                                                        Terminated
                                                    </a>
                                                {% endif %}
                                                <a
                                                    class="btn btn-sm btn-secondary"
                                                    href="{% url 'organisations:club_admin_edit_member_deceased' club_id=club.id system_number=member_details.system_number %}"
                                                >
                                                    Deceased
                                                </a>
                                            </div>
                                        </div>

                                        {% if member_details.membership_status == 'DUE' %}
                                            <a
                                                class="btn btn-sm btn-primary"
                                                href="{% url 'organisations:club_admin_edit_member_paid' club_id=club.id system_number=member_details.system_number %}"
                                            >
                                                Mark as Paid
                                            </a>

                                        {% endif %}

                                        {% if member_details.membership_status == 'CUR' and not member_details.latest_membership.membership_type.does_not_renew %}
                                            <button
                                                class="btn btn-sm btn-primary"
                                                hx-get="{% url 'organisations:club_admin_edit_member_extend_htmx' club_id=club.id system_number=member_details.system_number %}"
                                                hx-target="#id_action_pane"
                                            >
                                                Extend Membership
                                            </button>
                                        {% endif %}

                                        {% if member_details.membership_status == 'LAP' or member_details.membership_status == 'RES' or member_details.membership_status == 'TRM' %}

                                            <button
                                                class="btn btn-sm btn-primary"
                                                hx-post="{% url 'organisations:club_admin_edit_member_reinstate_htmx' club_id=club.id system_number=member_details.system_number %}"
                                                hx-target="#id_action_pane"
                                            >
                                                Reinstate Membership
                                            </button>

                                        {% endif %}

                                        {% if member_details.membership_status == 'DUE' or member_details.membership_status == 'CUR' %}

                                            <button
                                                class="btn btn-sm btn-primary"
                                                hx-get="{% url 'organisations:club_admin_edit_member_change_htmx' club_id=club.id system_number=member_details.system_number %}"
                                                hx-target="#id_action_pane"
                                                hx-trigger="click"
                                            >
                                                Change Membership Type
                                            </button>

                                        {% endif %}

                                    {% endif %}

                                    {% if allow_deletion %}
                                        <a
                                            class="btn btn-sm btn-primary"
                                            href="{% url 'organisations:club_admin_edit_member_delete' club_id=club.id system_number=member_details.system_number %}"
                                        >
                                            Delete
                                        </a>
                                    {% endif %}

                                    <div class="row" id="id_action_pane">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MEMBER DETAILS -->

                <div class="card mt-5">
                    <div class="card-header card-header-warning">
                        Member Details
                    </div>
                    <div class="container">
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}

                                <!-- EMAIL -->
                                <div class="row pb-2">
                                    <div class="col-2 justify-content-center align-self-center pt-3">
                                        Email
                                    </div>
                                    <div class="col-8">
                                        <div id="div_id_email" class="form-group">
                                            <span class="cobalt-form-error" id="id_email_errors">
                                                {{ form.email.errors|striptags }}
                                            </span>
                                            {% render_field form.email class+="form-control" %}
                                        </div>
                                    </div>
                                </div>
                                {% if member_details.email_hard_bounce %}
                                    <div class="row pb-2">
                                        <div class="col-2"></div>
                                        <div class="col-8">
                                            Warning - this email address bounced!
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- MOBILE AND OTHER PHONE -->
                                <div class="row pb-2">
                                    <div class="col-2 justify-content-center align-self-center">
                                        Mobile
                                    </div>
                                    <div class="col-3">
                                        <div id="div_id_mobile" class="form-group">
                                            <span class="cobalt-form-error" id="id_mobile_errors">
                                                {{ form.mobile.errors|striptags }}
                                            </span>
                                            {% render_field form.mobile class+="form-control" %}
                                        </div>
                                    </div>
                                    <div class="col-2 justify-content-center align-self-center">
                                        Other phone
                                    </div>
                                    <div class="col-3">
                                        <div id="div_id_other_phone" class="form-group">
                                            <span class="cobalt-form-error" id="id_other_phone_errors">
                                                {{ form.other_phone.errors|striptags }}
                                            </span>
                                            {% render_field form.other_phone class+="form-control" %}
                                        </div>
                                    </div>
                                </div>

                                <!-- ADDRESS 1 -->
                                <div class="row pb-2">
                                    <div class="col-2 justify-content-center align-self-center pt-3">
                                        Address 1
                                    </div>
                                    <div class="col-8">
                                        <div id="div_id_address1" class="form-group">
                                            <span class="cobalt-form-error" id="id_address1_errors">
                                                {{ form.address1.errors|striptags }}
                                            </span>
                                            {% render_field form.address1 class+="form-control" %}
                                        </div>
                                    </div>
                                </div>

                                <!-- ADDRESS 2 -->
                                <div class="row pb-2">
                                    <div class="col-2 justify-content-center align-self-center">
                                        Address 2
                                    </div>
                                    <div class="col-8">
                                        <div id="div_id_address2" class="form-group">
                                            <span class="cobalt-form-error" id="id_address2_errors">
                                                {{ form.address2.errors|striptags }}
                                            </span>
                                            {% render_field form.address2 class+="form-control" %}
                                        </div>
                                    </div>
                                </div>

                                <!-- STATE POSTCODE -->
                                <div class="row pb-2">
                                    <div class="col-2 justify-content-center align-self-center">
                                        State
                                    </div>
                                    <div class="col-3">
                                        <div id="div_id_state" class="form-group">
                                            <span class="cobalt-form-error" id="id_state_errors">
                                                {{ form.state.errors|striptags }}
                                            </span>
                                            {% render_field form.state class+="form-control" %}
                                        </div>
                                    </div>
                                    <div class="col-2 justify-content-center align-self-center">
                                        Postcode
                                    </div>
                                    <div class="col-3">
                                        <div id="div_id_postcode" class="form-group">
                                            <span class="cobalt-form-error" id="id_postcode_errors">
                                                {{ form.postcode.errors|striptags }}
                                            </span>
                                            {% render_field form.postcode class+="form-control" %}
                                        </div>
                                    </div>
                                </div>

                                <!-- DOB AND CLUB NUMBER -->
                                <div class="row pb-2">
                                    <div class="col-2 justify-content-center align-self-center">
                                        Date of birth
                                    </div>
                                    <div class="col-3">
                                        <div id="div_id_dob" class="form-group">
                                            <span class="cobalt-form-error" id="id_dob_errors">
                                                {{ form.dob.errors|striptags }}
                                            </span>
                                            {% render_field form.dob class+="form-control" %}
                                        </div>
                                    </div>
                                    <div class="col-2 justify-content-center align-self-center">
                                        Club membership number
                                    </div>
                                    <div class="col-3">
                                        <div id="div_id_club_membership_number" class="form-group">
                                            <span class="cobalt-form-error" id="id_club_membership_number_errors">
                                                {{ form.club_membership_number.errors|striptags }}
                                            </span>
                                            {% render_field form.club_membership_number class+="form-control" %}
                                        </div>
                                    </div>
                                </div>

                                <!-- EMERGENCY CONTACT -->
                                <div class="row pb-2">
                                    <div class="col-2 justify-content-center align-self-center">
                                        Emergency contact
                                    </div>
                                    <div class="col-8">
                                        <div id="div_id_emergency_contact" class="form-group">
                                            <span class="cobalt-form-error" id="id_emergency_contact_errors">
                                                {{ form.emergency_contact.errors|striptags }}
                                            </span>
                                            {% render_field form.emergency_contact class+="form-control" %}
                                        </div>
                                    </div>
                                </div>

                                <!-- NOTES -->
                                <div class="row pb-2">
                                    <div class="col-12 my-4">
                                        <div class="form-group">
                                            <label class="bmd-label-floating" for="id_notes">
                                                Notes
                                            </label>
                                            {% cobalt_bs4_field form.notes no_label=True %}
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success cobalt-save">Save</button>
                            </form>
                        </div>
                    </div>

                </div>

                <div class="card mt-5">
                    <div class="card-header card-header-warning">
                        Change History
                    </div>
                    <div class="container">
                        <div class="card-body">

                            {% if log_history %}
                                <!-- LOG HISTORY TABLE -->

                                <div class="table-responsive">
                                    <table class="table table-condensed table-hover">
                                        <thead>
                                            <tr>
                                                <th class="text-left">Date</th>
                                                <th class="text-left">Description</th>
                                                <th class="text-left">By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for log in log_history %}
                                                <tr>
                                                    <td class="text-left">{{ log.date }}</td>
                                                    <td class="text-left">{{ log.description }}</td>
                                                    <td class="text-left">{{ log.actor }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                No changes have been made
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('htmx:afterSettle', function(event) {

            if (event.detail.target.id === 'id_action_pane') {
                // hook for any initialisation required for the form entry in the action pane
                initialiseHTMXForm();
            }
        });

    </script>

{% endblock content %}
