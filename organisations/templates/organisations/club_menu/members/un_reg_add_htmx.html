{% load crispy_forms_filters %}
{% load cobalt_tags %}
{% load crispy_forms_tags %}

<div class="card col-md-9 col-lg-6">
    <div class="card-header card-header-rose">
        <h2 class="text-center">{{ un_reg }}</h2>
        <h3 class="text-center">
            Add Unregistered Member
        </h3>
        <p class="text-center">Here you can add a member who has not yet registered for {{ GLOBAL_TITLE }}</p>
    </div>
    <div class="card-body pt-0">

        <p class="mt-3">There are two emails option that can be changed. The main email address is the
            centrally registered one for this (unregistered) user. You can edit this if your club
            added this user. This is visible and usable by all other clubs. If you wish to keep
            the email private or to override it, then you can use a club-specific email address.</p>
        <p>To make things even easier, invite this user to sign up for {{ GLOBAL_TITLE }} so
            they can manage their own contact details as well as the other benefits of membership.</p>

        <h3 class="text-info font-weight-bold settings_message" id="user_edit_message">{{ message }}</h3>

        <form
            hx-post="{% url "organisations:club_menu_tab_members_add_un_reg_htmx" %}"
            hx-target="#id_member_add_tab"
            hx-vars="club_id:{{ club.id }}"
        >

            <span id="username_error" class="cobalt-form-error"></span>

            {{ form.system_number | as_crispy_field }}
            {{ form.first_name | as_crispy_field }}
            {{ form.last_name | as_crispy_field }}
            {{ form.mpc_email | as_crispy_field }}
            {{ form.club_email | as_crispy_field }}

            {#        Cripsy forms stuff up these fields#}

            <div id="div_id_membership_type" class="form-group row">
                <div class="col-6">
                    <label for="id_membership_type" class="bmd-label-static">
                        Membership type
                    </label>
                </div>

                <div class="col-6">
                    <span class="cobalt-form-error">{{ form.membership_type.errors|striptags }}</span>
                    <select name="membership_type" class="select form-control" id="id_membership_type">
                        {% for option in form.membership_type.field.choices %}
                            <h1>{{ option }}</h1>
                            <option value="{{ option.0 }}">{{ option.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <span class="cobalt-form-error">{{ form.home_club.errors|striptags }}</span>
                <input id="id_home_club" type="checkbox" name="home_club" {% if form.home_club.value %}Checked{% endif %}">
                <label for="id_home_club" style="color: black">&nbsp;Home Club</label><br>

            </div>

            <button type="submit" name="save" class="btn btn-success">Save</button>
            <button type="reset" class="btn btn-info">Cancel</button>
        </form>


    </div>
</div>

<script>
    jQuery(document).ready(function() {

        function getPlayerName() {

            const username = document.getElementById('id_system_number');
            const fname = document.getElementById('id_first_name');
            const lname = document.getElementById('id_last_name');
            const err = document.getElementById('username_error');

            err.innerHTML = "";

            var trimmed_username = username.value.replace(/^\s+|\s+$/g, '');

            if (trimmed_username === '') {
                return;
            }

            var strURL = "{% url "masterpoints:system_number_lookup" %}?system_number=" + trimmed_username;

            jQuery.ajax({
                url: strURL,
                context: document.body,
                success: function(txt) {

                    const res = txt.split(" ");
                    if (res.length === 2) {
                        fname.value = res[0];
                        lname.value = res[1];
                    }
                    const n = txt.search("Error");
                    if (n >= 0) {
                        username.focus();
                        err.innerHTML = txt;

                    }
                }
            });
        }

        jQuery('#id_system_number').on('change blur', function(e) {
            getPlayerName();
        });

    });

</script>
