#!/bin/sh

cat << EOF

CGIT - Cobalt Git Commands

These cgit commands automate the Git and Elastic Beanstalk commands
used for standard activities. 

For most commands to work you will need to be on the relevant branch.
Use git checkout [branch] if necessary.

Dev/Test
--------

cgit_dev_start            - start a new feature
cgit_dev_save             - save work so far
cgit_dev_finish           - merges into develop and deploys to test

UAT
---

cgit_uat_publish          - pushes current develop to UAT, creates release
cgit_uat_fix_start        - creates bugfix for a release in UAT
cgit_uat_fix_save         - saves work so far 
cgit_uat_fix_finish       - releases fix to UAT

Production
----------

cgit_prod_publish         - push release to production
cgit_prod_hotfix_start    - create hotfix 
cgit_prod_hotfix_save     - save work so far 
cgit_prod_hotfix_test     - releases hotfix to a test environment
cgit_prod_hotfix_finish   - releases hotfix to production

General
-------

cgit_util_compare              - compare this branch to what is running in test, uat or production

Current Status
--------------

EOF

RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Be careful with AWS env variables
unset AWS_SECRET_ACCESS_KEY
unset AWS_ACCESS_KEY_ID

# Get this branch
BRANCH=$(git branch --show-current)

# Function to work with environments
get_status() {
  THISNAME=$1
  THISSEARCH=$2
  REFBRANCH=$3

  # Get full environment name from ebcli
  THISENV=$(eb list | grep $THISSEARCH | tr \* " ")

  # Get which application is installed on this environment
  APP=$(eb status $THISENV | grep Deploy | awk '{print $3}')

  # Use aws cli to get the description for this application
  DESC=$(aws elasticbeanstalk describe-application-versions --version-label "$APP" | grep Description | awk '{print $2}' | tr -d '"' | tr -d ,)

  # Description is branch@timestamp - get branch
  THISBRANCH=$(echo $DESC | tr '@' ' ' | awk '{print $1}')

  # Make sure we have latest copy of branch for reference
  git fetch origin $THISBRANCH >/dev/null 2>&1

  # See how many files different from reference branch
  FILE_DIFF=$(git diff --name-status $THISBRANCH..$REFBRANCH | wc | awk '{print $1}')

  # Get the timestamp from the description and replace _ with space
  TIMESTAMP=$(echo $DESC|cut -d@ -f2 | tr '_' ' ')

  # Print summary
  printf "$THISNAME is running: ${YELLOW}${THISBRANCH}${NC} ${BLUE}${TIMESTAMP}${NC} [$FILE_DIFF files different from $REFBRANCH]\n"
}

get_status "Test" "cobalt-test" $BRANCH
get_status "UAT" "cobalt-uat" "develop"
get_status "Production" "cobalt-production" "develop"


