{% extends 'base.html' %}
{% load static %}
{% load cobalt_tags %}
{% block header %}
{#    <link rel="stylesheet" type="text/css" href="{% static "assets/js/datatables.1.10.25/DataTables-1.10.25/css/dataTables.bootstrap4.css" %}"/>#}
{#    <link rel="stylesheet" type="text/css" href="{% static "assets/js/datatables.1.10.25/DataTables-1.10.25/re" %}"/>#}
{#    <script type="text/javascript" src="{% static "assets/js/datatables.1.10.25/DataTables-1.10.25/js/dataTables.bootstrap.min.js" %}"></script>#}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap4.min.css"/>

<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap4.min.js"></script>


{% endblock %}
{% load log %}
{% block content %}
<div id="ignore_cobalt_save"></div>
<div class="col-md-12">
  <div class="card">
    <div class="card-header card-header-warning">
      <h1>
        <div class="d-flex justify-content-between">
          <div>
            Logs
          </div>
          <div>
            <i class="material-icons" style="font-size:50px">build</i>
          </div>
      </h1>
    </div>
    <div class="card-body table-responsive">
        <select class="selectpicker" data-style="btn btn-info" id="id_days" name="days">
            <option value="7" {% if days == 7 %}selected{% endif %}>1 Week</option>
            <option value="14"{% if days == 14 %}selected{% endif %}>2 Weeks</option>
            <option value="31"{% if days == 31 %}selected{% endif %}>1 Month</option>
        </select>
        <select class="selectpicker" data-style="btn btn-danger" id="id_severity" name="severity">
            <option value="All">Severity - All</option>
            {% for severity in severities %}
                <option
                        {% if form_severity == severity.severity %}selected{% endif %}
                        value="{{ severity.severity }}">
                    {{ severity.severity }}
                </option>
            {% endfor %}
        </select>
        <select class="selectpicker" data-style="btn btn-success" id="id_source" name="source">
            <option value="All">Source - All</option>
            {% for source in sources %}
                <option
                        {% if form_source == source.source %}selected{% endif %}
                        value="{{ source.source }}">
                    {{ source.source }}
                </option>
            {% endfor %}
        </select>
    {% if sub_sources %}
        <select class="selectpicker" data-style="btn btn-warning" id="id_sub_source" name="sub_source">
            <option value="All">Sub-Source - All</option>
            {% for sub_source in sub_sources %}
                <option
                        {% if form_sub_source == sub_source.sub_source %}selected{% endif %}
                        value="{{ sub_source.sub_source }}">
                    {{ sub_source.sub_source }}
                </option>
            {% endfor %}
        </select>
    {% endif %}
        <select class="selectpicker" data-style="btn btn-primary" id="id_user" name="user">
        <option value="All">Users - All</option>
        {% for user in users %}
            <option
                    {% if form_user == user.user %}selected{% endif %}
                    value="{{ user.user }}">
                {{ user.user }}
            </option>
        {% endfor %}
    </select>

        <a href="{% url 'logs:logs' %}" class="float-right btn btn-default">Clear</a>

      <table id="log_table" class="table table-hover table-condensed">
        <thead class="text-info">
          <tr>
            <th>Time</th>
            <th>IP</th>
            <th>Severity</th>
            <th>User</th>
            <th>Source</th>
            <th>Sub Source</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody>
          {% for thing in things %}
          <tr>
            <td title="{{ thing.event_date|timesince }} ago" data-toggle="tooltip">{{ thing.event_date|cobalt_nice_datetime }}</td>
            <td><a href="https://www.infosniper.net/index.php?ip_address={{ thing.ip }}">{{ thing.ip }}</a></td>
            <td class="

              {% if thing.severity == "DEBUG" %}bg-white{% endif %}
              {% if thing.severity == "INFO" %}bg-light{% endif %}
              {% if thing.severity == "WARN" %}bg-info{% endif %}
              {% if thing.severity == "ERROR" %}bg-warning{% endif %}
              {% if thing.severity == "HIGH" %}bg-danger text-blue{% endif %}
              {% if thing.severity == "CRITICAL" %}bg-dark text-white font-weight-bold{% endif %}

              ">{{ thing.severity }}</td>
            <td>{{ thing.user }}</td>
            <td>{{ thing.source }}</td>
            <td>{{ thing.sub_source }}</td>
            <td class="text-left">{{ thing.message }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% include 'utils/pagination_footer.html' %}

    </div>
  </div>
</div>
{% endblock %}
{% block footer %}
<script src="{% static "assets/js/plugins/bootstrap-selectpicker.js" %}"></script>
<script>
$(document).ready( function () {

    // Initialise datatable - only show pagination if more than one page
    $('#log_table').DataTable({
        drawCallback: function(settings) {
        var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
        pagination.toggle(this.api().page.info().pages > 1);
        }
    });

    // initialise tooltips
    $('[data-toggle="tooltip"]').tooltip()

    // handle changes in selection
    function reload_page(){
        const days = $('#id_days').val();
        const severity = $('#id_severity').val();
        const source = $('#id_source').val();
        const user = $('#id_user').val();
        const sub_source = $('#id_sub_source').val();
        let query = '?days=' + days + '&severity=' + severity + '&source=' + source + '&user=' + user;
        if (sub_source){
            query += '&sub_source=' + sub_source;
        }
        window.location.replace('{% url "logs:logs" %}' + query);
    }

    $('.selectpicker').on('change', function() {
       reload_page();
    });
});
</script>

{% endblock %}
