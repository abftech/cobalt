{#------------------------------------------------------------------------------#}
{#                                                                              #}
{# High level page for Club Sessions. Present the tabs and uses HTMX to manage. #}
{#                                                                              #}
{#------------------------------------------------------------------------------#}
{% extends 'base.html' %}

{% load static %}
{% load cobalt_tags %}

{% block title %}- {{ session.session_date }}{% endblock %}

{% block header %}
    {#------------------------------------------------------------------------#}
    {#                                                                        #}
    {# Styles have to be loaded on the first html page                        #}
    {#                                                                        #}
    {# Please document what they do if you add any                            #}
    {#                                                                        #}
    {#------------------------------------------------------------------------#}

    <style>
        /* Used for material icons on results */

        .inline-icon {
            vertical-align: bottom;
            font-size: 22px !important;
        }

        /* Used for progress wizard in totals */
        .steps-form {
            display: table;
            width: 100%;
            position: relative;
        }

        .steps-form .steps-row {
            display: table-row;
        }

        .steps-form .steps-row:before {
            top: 14px;
            bottom: 0;
            position: absolute;
            content: " ";
            width: 100%;
            height: 1px;
            background-color: #ccc;
        }

        .steps-form .steps-row .steps-step {
            display: table-cell;
            text-align: center;
            position: relative;
        }

        .steps-form .steps-row .steps-step p {
            margin-top: 0.5rem;
        }

        .steps-form .steps-row .steps-step button[disabled] {
            opacity: 1 !important;
            filter: alpha(opacity=100) !important;
        }

        .steps-form .steps-row .steps-step .btn-circle {
            width: 30px;
            height: 30px;
            text-align: center;
            padding: 6px 0;
            font-size: 12px;
            line-height: 1.428571429;
            border-radius: 15px;
            margin-top: 0;
        }

        /* Summary Table fixed layout */

        table.fixed-summary {
            table-layout:fixed; width:100%;
            font-size: large;
        }
        /* icon */
        table.fixed-summary td:nth-of-type(1) {
            width:10%;
            text-align: left;
            padding-left: 5px;
        }
        /* Name */
        table.fixed-summary td:nth-of-type(2) {
            width:60%;
            text-align: left;
        }
        /* Paid / Outstanding */
        table.fixed-summary td:nth-of-type(3) {
            width:30%;
        }
        /* Plus sign */
        table.fixed-summary td:nth-of-type(4) {
            width:10%;
            text-align: right;
            font-size: x-large;
            padding-right: 10px;
        }

    </style>

{% endblock header %}

{% block content %}

    <!-- BASIC HEADING -->

    <h1 class="text-center pt-4"><span id="t_club_name">{{ club }}</span> - {{ club.state }}</h1>

    <h2 class="text-center border-bottom-0"><span class="text-primary" style="font-size: 50px;">&hearts;</span>
        {{ session.description}} <span class="text-danger" style="font-size: 50px;">&hearts;</span>
    </h2>

    <h3 class="text-center mx-0"><span class="text-dark" style="font-size: 40px;">&spades;</span>
        {{ session.session_date }} <span class="text-dark" style="font-size: 40px;">&spades;</span>
    </h3>

    <!-- MAIN CARD BODY WITH NAVIGATION ICONS ON TOP -->
    <div class="card-body">

        <!-- NAVIGATION CARD -->
        <div class="card">

            <!-- NAVIGATION CARD HEADER -->
            <div class="card-header card-header-secondary pb-0">

                <!-- BUTTONS ACROSS THE TOP -->
                <ul id="id_menu" class="nav nav-pills nav-pills-icons" role="tablist">

                    <!-- SETTINGS -->
                    <li class="nav-item">
                        <a id="id_tab_basics" class="nav-link auto-refresh" href="#basics" role="tab" data-toggle="tab">
                            <i class="material-icons">settings</i>
                            Settings
                        </a>
                    </li>

                    <!-- SESSION -->
                    <li class="nav-item">
                        <a id="id_tab_session" class="nav-link
                            {% if has_session_entries %}
                                active
                            {% endif %}
                            auto-refresh" href="#session" role="tab" data-toggle="tab">
                            <i class="material-icons">groups</i>
                            Session
                        </a>
                    </li>

                    <!-- REPORTS -->
                    <li class="nav-item">
                        <a id="id_tab_report"
                            class="nav-link auto-refresh"
                            href="#reports"
                            role="tab"
                            data-toggle="tab">
                            <i class="material-icons">description</i>
                            Reports
                        </a>
                    </li>

                </ul>

                <!-- SPINNER -->
                <div class='justify-content-center text-center'>
                    <span class="htmx-indicator" id="spinner">
                        <img style="width: 40px" src="{% static "assets/img/spinners/bars.svg" %}"/>
                    </span>
                </div>

            </div>

            <!-- MAIN BODY OF PAGE -->
            <div class="card-body" style="min-height: 500px;">
                <div class="tab-content tab-space pt-0">

                    <!-- SETTINGS -->
                    <div class="tab-pane" id="basics">
                        <h3 class="mt-0">Settings</h3>
                        <div id="id_pane_settings">
                            <div
                                hx-post="{% url "club_sessions:tab_settings_htmx" %}"
                                hx-trigger="load"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
                            ></div>
                        </div>
                    </div>

                    <!-- SESSION -->
                    <div class="tab-pane
                        {% if has_session_entries %}
                            active
                        {% endif %}

                        " id="session">

                        <!-- TOTALS - RUN ON LOAD OR TRIGGER FROM OTHER UPDATES -->

                        {% if has_session_entries %}

                            <div id="id_totals"
                                hx-post="{% url "club_sessions:session_entry_session_totals_htmx" %}"
                                hx-trigger="load, update_totals"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
                            >
                            </div>

                        {% endif %}

                        <!-- THIS IS THE ACTUAL DIV FOR SESSIONS -->
                        <div id="id_pane_session"
                            hx-post="{% url "club_sessions:tab_session_htmx" %}"
                            hx-trigger="load, tab_load_event, reload_sessions from:body"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
                            hx-target="#id_pane_session"
                            hx-indicator="#spinner"
                        ></div>
                    </div>

                    <!-- REPORTS -->
                    <div class="tab-pane" id="reports">
                        <h3 class="mt-0">Reports</h3>

                        <!-- MENU -->
                        <!-- RECONCILIATION REPORT -->
                        <button
                            class="btn btn-success"
                            hx-post="{% url "club_sessions:reports_reconciliation_htmx" %}"
                            hx-trigger="click"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
                            hx-target="#id_pane_reports"
                        >
                            Basic
                        </button>

                        <!-- INCLUDE SPACES REPORT -->
                        <button
                            class="btn btn-success"
                            hx-post="{% url "club_sessions:reports_reconciliation_htmx" %}"
                            hx-trigger="click"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, show_blanks:1"
                            hx-target="#id_pane_reports"
                        >
                            Full
                        </button>

                        <!-- LOW BALANCE REPORT -->
                        <button
                            class="btn btn-success"
                            hx-post="{% url "club_sessions:reports_low_balance_report_htmx" %}"
                            hx-trigger="click"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, show_blanks:1"
                            hx-target="#id_pane_reports"
                        >
                            Low Balance
                        </button>

                        <!-- IMPORT MESSAGES -->
                        <button
                            class="btn btn-success"
                            hx-post="{% url "club_sessions:reports_import_messages_htmx" %}"
                            hx-trigger="click"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
                            hx-target="#id_pane_reports"
                        >
                            Messages
                        </button>

                        <!-- CSV -->
                        <a
                            class="btn btn-success"
                            href="{% url "club_sessions:reports_csv_download" session_id=session.id %}"
                        >
                            CSV
                        </a>


                        <!-- MAIN DIV - PRELOAD WITH FIRST REPORT - RECONCILIATIONS -->
                        <div id="id_pane_reports"
                            hx-post="{% url "club_sessions:reports_reconciliation_htmx" %}"
                            hx-trigger="load, tab_load_event"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
                        ></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock content %}

{% block footer %}
    <script src="{% static "assets/js/plugins/bootstrap-selectpicker.js" %}"></script>
    <script src="{% static "assets/js/plugins/sweetalert2.js" %}"></script>

    <script>

        $(document).ready(function () {

            // When totals does something it updates the bottom part, also send message to update totals
            document.body.addEventListener("update_totals", function (evt) {
                htmx.trigger(htmx.find('#id_totals'), "update_totals");
            });


            $(document).ready(function () {

                // When a tab is clicked we reload the data

                $('#id_menu a').on('click', function (e) {

                    const id = this.id.split("_")[2];

                    if (id === "report"){
                        htmx.trigger(htmx.find("#id_pane_reports"), "tab_load_event");
                    }
                    {#if (id === "session"){#}
                    {#    htmx.trigger(htmx.find("#id_pane_session"), "tab_load_event");#}
                    {#htmx.trigger(htmx.find("#id_totals"), "update_totals");#}
                    {#}#}

                });

            })
        });

    </script>

{% endblock footer %}
