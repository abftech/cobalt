{% load static %}
{#---------------------------------------------------------------------------------#}
{#                                                                                 #}
{# Screen to allow a director to edit the details for a single player in a session #}
{#                                                                                 #}
{#---------------------------------------------------------------------------------#}
{% load cobalt_tags %}
{% load humanize %}

<!-- BUTTON TO RETURN TO SESSION PAGE -->
<button class="btn btn-outline-secondary btn-sm"
    hx-post="{% url "club_sessions:tab_session_htmx" %}"
    hx-target="#id_pane_session"
    hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
>

    <span class="material-icons">arrow_back</span>

    Back To Full List
</button>

<div>
    <!-- PLAYER DETAILS -->
    <div class="card">

        <div class="card-header card-header-rose">
            <h2 class="text-center">Seat: {{ session_entry.pair_team_number }}{{ session_entry.seat }}</h2>

            <!-- HANDLE NON-USERS -->

            {% if session_entry.system_number == -1 %}
                <!-- SIT OUT -->
                <h3 class="card-title text-center">Sitout</h3>

            {% elif session_entry.system_number == 1 %}
                <!-- PLAYING DIRECTOR -->
                <h3 class="card-title text-center">PLAYING DIRECTOR</h3>

            {% elif session_entry.system_number == 0 %}
                <!-- NON ABF GUEST -->
                <h3 class="card-title text-center">{{ session_entry.player_name_from_file|lower|title }}</h3>
                <h4 class="card-title text-center">Visitor without {{ GLOBAL_ORG }} Number</h4>

            {% else %}
                {% if form.is_user %}
                    <div class="card-profile">
                        <img id="cobalt-pic" class="cobalt-rounded text-center" style="height: 100px; width: 100px;" src="/media/{{ form.player.pic }}" />
                    </div>
                {% endif %}
                <h3 class="card-title text-center">{{ form.player.full_name }} ({{ session_entry.system_number }})</h3>
                <h4 class="card-title text-center">{{ form.player_type }}</h4>

                <!-- SHOW BALANCE IF A REAL USER -->
                {% if form.is_user %}
                    <h3 class="text-center">Balance:
                        <span
                            hx-trigger="load"
                            hx-post="{% url "organisations:get_member_balance_htmx" %}"
                            hx-vars="member: {{ form.player.id }}"
                            hx-target="this"
                        >

                        </span></h3>
                    {% if form.player.stripe_auto_confirmed %}
                        <h4 class="text-center">Auto Top Up Enabled</h4>
                    {% endif %}
                {% endif %}

                {% if form.is_member %}
                    <h3 class="text-center">Membership Type: {{ form.membership_type.membership_type.name }}</h3>
                {% else %}
                    <h3 class="text-center">Not a Member</h3>
                {% endif %}
            {% endif %}
        </div>

        <div class="card-body">

            <!-- MESSAGE -->
            <h3 class="text-primary font-weight-bold">{{ message }}</h3>

            <!-- CARD FOR BASIC INFO -->
            <div class="container">
                <div class="row">
                    <div class="card col-md-6">
                        <div class="card-header-danger">
                            <h3>Session Details</h3>
                        </div>
                        <div class="card-body">

                            <form
                                id="player_form"
                                hx-post="{% url "club_sessions:edit_session_entry_htmx" %}"
                                hx-target="#id_pane_session"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}
                                {% if form.is_user %}, is_user:1{% endif %}
                                {% if form.is_un_reg %}, is_un_reg:1{% endif %}
                                "
                            >

                                <div class="container">

                                    <!-- PLAYER NAME - SHOWN IF CHANGED -->
                                    <div id="id_player_name" class="d-none">
                                        <div class="row">
                                            <div class="col">
                                                <div class="form-group">
                                                    <label class="bmd-label-floating" for="id_player_name_input">
                                                        Changing Name To
                                                    </label>
                                                    <input class="form-control" id="id_player_name_input" type="text" value="" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- SEARCH BUTTONS DEPENDING UPON USER TYPE -->
                                    {% if form.is_user %}
                                        <button id="user_change_button" type="button" class="btn btn-info" data-toggle="modal" data-target="#userSearchModal9"><span class="material-icons">person</span> Change User</button>
                                    {% endif %}

                                    {% if form.is_un_reg %}
                                        <button id="user_change_button" type="button" class="btn btn-info" data-toggle="modal" data-target="#userSearchModal99"><span class="material-icons">person</span> Change User</button>
                                    {% endif %}

                                    <!-- PLAYER NO - HIDDEN -->
                                    <input type="hidden" value="{{ form.player_no.value }}" name="player_no" id="id_player_no">

                                    <!-- FEE -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                {% cobalt_bs4_field form.fee  %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- AMOUNT PAID -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">
                                                {% cobalt_bs4_field form.amount_paid  %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- PAYMENT METHOD -->
                                    <div class="row">
                                        <div class="col">
                                            <div class="form-group">

                                                <!-- HANDLE PAYMENT METHOD NOT BEING VALID ANY MORE -->
                                                {% if not payment_method_is_valid %}

                                                    <h4>Payment method {{ session_entry.payment_method.payment_method }} is no longer accepted. Changing this entry in any way will change the payment method to a currently valid one</h4>

                                                {% endif %}

                                                <label class="bmd-label-floating" for="id_payment_method">
                                                    Payment Method
                                                </label>
                                                {% cobalt_bs4_field form.payment_method  %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- BUTTONS -->
                                <div class="row mt-5">
                                    <div class="col">
                                        <button id="id_save_session" class="btn btn-sm btn-success" disabled name="save_session"
                                        >Save</button>

                                        <button class="btn btn-sm btn-info"
                                            hx-post="{% url "club_sessions:tab_session_htmx" %}"
                                            hx-target="#id_pane_session"
                                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
                                        >Cancel</button>
                                    </div>
                                </div>

                            </form>
                        </div>
                    </div>

                    <!-- ADVANCED CARD -->
                    <div class="col-md-6">
                        <div id="entry_extras"
                            hx-post="{% url "club_sessions:edit_session_entry_extras_htmx" %}"
                            hx-trigger="load"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                            hx-target="this"
                        ></div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% include "accounts/search/user_search_include_htmx.html" with search_id=9 include_me=True callback="ChangeUser" %}
{% include "accounts/search/user_search_include_htmx.html" with unregistered=True search_id=99 include_me=True callback="ChangeUser" %}

<script>
    function ChangeUser(search_id, user_id, user_name) {
        // update player number and name and display name
        $("#id_player_no").val(user_id);
        $("#id_player_name").removeClass("d-none");
        $("#id_player_name_input").val(user_name);
        $("#user_change_button").text("Change User Again");
        $("#id_save_session").prop("disabled", false);
    };

    $(document).ready( function () {

        // Enable save button if changes are made
        $("#player_form input, #id_payment_method").change(function(){
            $("#id_save_session").prop("disabled", false);
        });
    });

</script>


