{#------------------------------------------------------------------------#}
{#                                                                        #}
{# Session view tab                                                       #}
{#                                                                        #}
{# This is the main tab for this page                                     #}
{#                                                                        #}
{#------------------------------------------------------------------------#}
{% load cobalt_tags %}
{% load static %}

{% if not session_entries %}

    <h4>No players found. Either import players from the <b>IMPORTS</b> tag or click below to add a table manually.</h4>

{% else %}

    <div id="loading_message">
        <h3>Loading...</h3>
    </div>

    <!-- DELETE ME -->
    <ul>
        <li>Pay all</li>
        <li>Low balance warning</li>
        <li>Change all payment methods (except already set)</li>
        <li>Add table</li>
        <li>Handle director playing</li>
        <li>Handle unknown numbers</li>
        <li>Visual for being paid for</li>
        <li>Outstanding IOUs</li>
        <li>Flag for automatic IOUs?</li>
        <li>Block editing paid_amount field for bridge credits</li>
        <li>Hover text on player icon</li>
    </ul>

    <!-- TOTALS - RUN ON LOAD OR TRIGGER FROM OTHER UPDATES -->

    <div id="id_totals"
        hx-post="{% url "club_sessions:session_entry_session_totals_htmx" %}"
        hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}"
        hx-trigger="load, other_update"
    >
    </div>

    <div class="table-responsive d-none" id="main_session_table">

        <!-- MAIN TABLE -->

        <table class="table table-condensed table-bordered" style="cursor: cell;">

            <thead class="thead-dark">

                <tr>
                    <th>Table</th>
                    <th>Direction</th>
                    <th class="text-left">Player</th>
                    <th>Fee</th>
                    <th>Extras</th>
                    <th>Total</th>
                    <th>Payment Method</th>
                    <th>Paid</th>
                    <th>Actions</th>
                </tr>

            </thead>

            <tbody>

                <!-- TABLE ROW -->

                {% for session_entry in session_entries %}

                    <!-- ALTERNATE TABLE COLOURS -->

                    <tr
                        {% if session_entry.table_colour == "even" %}
                            style="background-color: #ECF0F1"
                        {% endif %}
                    >
                        <!-- TABLE NUMBER -->

                        <td style="font-size: large">{{ session_entry.pair_team_number }}</td>

                        <!-- DIRECTION -->

                        <td>
                            <span class="btn btn-sm btn-danger m-0 b-0 p-0" style="width: 50px">
                                <span style="font-size: large;">
                                    {{ session_entry.seat }}
                                </span>
                            </span>
                        </td>

                        <!-- PLAYER NAME -->

                        <td class="text-left">

                            <!-- PLAYER NAME - ICON WITH STATUS -->

                            <span class="myHover text-{{ session_entry.icon_colour }}"
                                data-toggle="tooltip"
                                title="{{ session_entry.icon_text}}"
                                data-delay="100"
                            >
                                <span class="material-icons" style="display: inline-flex; vertical-align: middle;">
                                    {{ session_entry.icon }}
                                </span>
                            </span>

                            {% if session_entry.balance < 20 %}
                                <span class="myHover text-dark"
                                    data-toggle="tooltip"
                                    title="Low balance {{ session_entry.balance }}"
                                    data-delay="100"
                                >
                                    <span class="material-icons" style="display: inline-flex; vertical-align: middle;">
                                        {% if session_entry.balance == 0 %}
                                            battery_0_bar
                                        {% else %}
                                            battery_2_bar
                                        {% endif %}
                                    </span>
                            {% endif %}
                        </span>

                        <!-- PLAYER NAME - NAME -->

                        <span style="font-size: larger; display: inline-flex; vertical-align: middle;">
                            <a href="javascript:void(0);"
                                hx-post="{% url "club_sessions:edit_session_entry_htmx" %}"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                                hx-target="#id_pane_session"
                            >
                                {# TBA player will actually be a director #}
                                {% if session_entry.player.id == TBA_PLAYER %}
                                    PLAYING DIRECTOR
                                {% else %}
                                    {{ session_entry.player.full_name|default_if_none:session_entry.system_number }}
                                {% endif %}
                            </a>
                        </span>
                    </td>

                    <!-- ENTRY FEE -->

                    <td id="id_session_entry_fee_{{ session_entry.id }}">
                        {{ session_entry.fee|default_if_none:'-' }}
                    </td>

                    <!-- EXTRAS -->

                    <td>0.00</td>

                    <!-- PLAYER TOTAL -->

                    <td>TBA</td>

                    <!-- PAYMENT METHOD -->

                    <td>
                        {% if session_entry.player.id == TBA_PLAYER %}

                            &nbsp;

                        {% else %}

                            <!-- HANDLE INVALID PAYMENT METHOD IF STATIC DATA HAS CHANGED SINCE THIS WAS SET -->
                            {% if not session_entry.payment_method_is_valid %}
                                <p class="font-weight-bold">"{{ session_entry.payment_method.payment_method }}" is no longer valid</p>
                            {% endif %}

                            <select
                                id="payment_method_select_{{ session_entry.id }}"
                                class="selectpicker mx-0 px-0 bx-0"
                                data-style="btn btn-success btn-sm"
                                name="payment_method"
                                hx-post="{% url "club_sessions:session_entry_change_payment_method_htmx" %}"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                                hx-target="#id_session_entry_fee_{{ session_entry.id }}"
                                style="width: 30px;"
                            >

                                <!-- IF NO SELECTION THEN SHOW HEADING, ALSO IF INVALID -->

                                {% if not session_entry.payment_method or not session_entry.payment_method_is_valid %}
                                    <option selected disabled value="">Select...</option>
                                {% endif %}

                                {% for payment_method in payment_methods %}

                                    <!-- ONLY ALLOW BRIDGE CREDITS FOR REAL USERS -->
                                    {% if payment_method.payment_method != BRIDGE_CREDITS or session_entry.player_type == "User" %}

                                        <option value="{{ payment_method.id }}"
                                            {% if session_entry.payment_method.id == payment_method.id  %}
                                                selected
                                            {% endif %}
                                        >{{ payment_method.payment_method }}</option>

                                    {% endif %}

                                {% endfor %}
                            </select>
                        {% endif %}

                    </td>


                    <!-- AMOUNT PAID -->

                    <td>
                        <!--  DO NOTHING IF PLAYING DIRECTOR (TBA) -->
                        {% if session_entry.player.id == TBA_PLAYER %}

                            &nbsp;

                        {% else %}

                            <span
                                hx-post="{% url "club_sessions:session_entry_change_paid_amount_htmx" %}"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                                hx-include="#id_session_entry_paid_flag_{{ session_entry.id }}"
                                hx-swap="none"
                            >

                                <input
                                    name="paid_flag"
                                    class="paid_flag"
                                    id="id_session_entry_paid_flag_{{ session_entry.id }}"
                                    type="checkbox"

                                    {# MARK AS PAID IF PAID gte DUE #}

                                    {% if session_entry.amount_paid >= session_entry.fee %}
                                        checked
                                    {% endif %}

                                    {# DON'T ALLOW BRIDGE CREDITS TO BE EDITED HERE #}

                                    {% if session_entry.payment_method.payment_method == BRIDGE_CREDITS %}
                                        disabled
                                    {% endif %}
                                >
                            </span>


                        {% endif %}

                    </td>

                    <!-- ACTIONS -->
                    <td>
                        <a href="javascript:void(0);"
                            class="btn btn-info btn-sm"
                            hx-post="{% url "club_sessions:edit_session_entry_htmx" %}"
                            hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                            hx-target="#id_pane_session"
                        >edit
                        </a>
                    </td>


                    </tr>
                {% endfor %}

            </tbody>

        </table>

    </div>

{% endif %}

<button class="btn btn-info">Add Table</button>

<script>
    $(document).ready(function () {

        // initialise the tooltips
        $(".myHover").tooltip();

        // poke the selectpicker
        $('.selectpicker').selectpicker('refresh');

        // watch for selectpicker (only one is payment_type) changing
        // disable ticking paid box if this is bridge credits
        $('.selectpicker').change(function(evt) {

            // get id for this row from the id of this element
            const row_id = $(this).attr("id").split("_")[3];

            if ($(this).find(":selected").text() === "{{ BRIDGE_CREDITS }}"){
                $("#id_session_entry_paid_flag_" + row_id).attr("disabled", true);
            } else {
                $("#id_session_entry_paid_flag_" + row_id).removeAttr("disabled");
            }

        });

        // watch for any update field changing and reload totals
        $('.selectpicker, .paid_flag').change(function(evt) {
            htmx.trigger("#id_totals", "other_update");
        });


        // sleep time expects milliseconds
        function sleep (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        // Usage!
        sleep(500).then(() => {
            // Do something after the sleep!
            $("#loading_message").addClass('d-none');
            $("#main_session_table").removeClass('d-none');

        });
    });
</script>

