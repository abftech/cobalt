{% load cobalt_tags %}
{% load static %}

{% if not session_entries %}

    <h4>No players found. Either import players from the <b>IMPORTS</b> tag or click below to add a table manually.</h4>

{% else %}

    <div id="loading_message">
        <h3>Loading...</h3>
    </div>

    <!-- MAIN TABLE -->
    <ul>
        <li>Pay all</li>
        <li>Low balance warning</li>
        <li>Change all payment methods (except already set)</li>
        <li>Add table</li>
        <li>Handle director playing</li>
        <li>Handle unknown numbers</li>
        <li>Visual for being paid for</li>
        <li>Outstanding IOUs</li>
        <li>Flag for automatic IOUs?</li>
        <li>Block editing paid_amount field for bridge credits</li>
        <li>Hover text on player icon</li>
        <li><b>ADD RANDOM PAYMENTS TO CLUB MENU - MEMBERS ONLY</b></li>
    </ul>

    <div class="table-responsive d-none" id="main_session_table">

        <table class="table table-condensed table-bordered" style="cursor: cell;">

            <thead class="thead-dark">

                <tr>
                    <th>Table</th>
                    <th>Direction</th>
                    <th class="text-left">Player</th>
                    <th>Pay By</th>
                    <th>Fee</th>
                    <th>Paid</th>
                </tr>

            </thead>

            <tbody>

                <!-- TABLE ROW -->

                {% for session_entry in session_entries %}

                    <!-- ALTERNATE TABLE COLOURS -->

                    <tr
                        {% if session_entry.table_colour == "even" %}
                            style="background-color: #ECF0F1"
                        {% endif %}
                    >
                        <!-- TABLE NUMBER -->

                        <td style="font-size: large">{{ session_entry.pair_team_number }}</td>

                        <!-- DIRECTION -->

                        <td>
                            <span class="btn btn-sm btn-danger m-0 b-0 p-0" style="width: 50px">
                                <span style="font-size: large;">
                                    {{ session_entry.seat }}
                                </span>
                            </span>
                        </td>

                        <!-- PLAYER NAME -->

                        <td class="text-left">

                            <!-- PLAYER NAME - ICON -->

                            <span class="myHover text-{{ session_entry.icon_colour }}"
                                data-toggle="tooltip"
                                title="{{ session_entry.icon_text}}"
                                data-delay="100"
                            >
                                <span class="material-icons" style="display: inline-flex; vertical-align: middle;">
                                    {{ session_entry.icon }}
                                </span>
                            </span>

                            {% if session_entry.balance < 20 %}
                                <span class="myHover text-dark"
                                    data-toggle="tooltip"
                                    title="Low balance {{ session_entry.balance }}"
                                    data-delay="100"
                                >
                                    <span class="material-icons" style="display: inline-flex; vertical-align: middle;">
                                        battery_2_bar
                                    </span>
                            {% endif %}
                        </span>

                        <!-- PLAYER NAME - NAME -->

                        <span style="font-size: larger; display: inline-flex; vertical-align: middle;">
                            <a href="javascript:void(0);"
                                hx-post="{% url "club_sessions:edit_session_entry_htmx" %}"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                                hx-target="#id_pane_session"
                            >
                                {# TBA player will actually be a director #}
                                {% if session_entry.player.id == TBA_PLAYER %}
                                    PLAYING DIRECTOR
                                {% else %}
                                    {{ session_entry.player.full_name|default_if_none:session_entry.system_number }}
                                {% endif %}
                            </a>
                        </span>
                    </td>

                    <!-- PAYMENT METHOD -->

                    <td>
                        {% if session_entry.player.id == TBA_PLAYER %}

                            &nbsp;

                        {% else %}

                            <select
                                class="selectpicker"
                                data-style="btn btn-success btn-sm"
                                name="payment_method"
                                hx-post="{% url "club_sessions:session_entry_change_payment_method_htmx" %}"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                                hx-target="#id_session_entry_fee_{{ session_entry.id }}"

                                {# allow entering paid amount if this has a value #}
                                _="on change remove @disabled from #id_session_entry_amount_paid_{{ session_entry.id }}"

                            >
                                {# if no selection then show heading #}
                                {% if not session_entry.payment_method %}
                                    <option selected disabled value="">Select...</option>
                                {% endif %}

                                {% for payment_method in payment_methods %}
                                    {# only allow bridge credits for real users #}
                                    {% if payment_method.payment_method != "Bridge Credits" or session_entry.player_type == "User" %}

                                        <option value="{{ payment_method.id }}"
                                            {% if session_entry.payment_method.id == payment_method.id  %}
                                                selected
                                            {% endif %}
                                        >{{ payment_method.payment_method }}</option>

                                    {% endif %}

                                {% endfor %}
                            </select>
                        {% endif %}

                    </td>

                    <!-- ENTRY FEE -->

                    <td id="id_session_entry_fee_{{ session_entry.id }}">
                        {{ session_entry.fee|default_if_none:'-' }}
                    </td>

                    <!-- AMOUNT PAID -->

                    <td>
                        {#  do nothing if playing director (TBA) #}
                        {% if session_entry.player.id == TBA_PLAYER %}

                            &nbsp;

                        {% else %}

                            <span
                                hx-post="{% url "club_sessions:session_entry_change_paid_amount_htmx" %}"
                                hx-vars="club_id:{{ club.id }}, session_id:{{ session.id }}, session_entry_id:{{ session_entry.id }}"
                                hx-include="#id_session_entry_amount_paid_{{ session_entry.id }}"
                            >

                                <input name="amount_paid"
                                    id="id_session_entry_amount_paid_{{ session_entry.id }}"
                                    type="checkbox"
                                    class="toggle_button"
                                    data-toggle="toggle"
                                    data-size="xs"
                                    data-width="80"
                                    data-on="Paid"
                                    data-off="Unpaid"
                                    data-onstyle="primary"
                                    checked
                                />
                            </span>


                        {% endif %}

                    </td>

                    </tr>
                {% endfor %}

            </tbody>

        </table>

    </div>

{% endif %}

<button class="btn btn-info">Add Table</button>

<script>
    $(document).ready(function () {

        // initialise the tooltips
        $(".myHover").tooltip();

        // activate toggle buttons
        $('.toggle_button').bootstrapToggle();

        // poke the selectpicker
        $('.selectpicker').selectpicker('refresh');

        // sleep time expects milliseconds
        function sleep (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        // Usage!
        sleep(500).then(() => {
            // Do something after the sleep!
            $("#loading_message").addClass('d-none');
            $("#main_session_table").removeClass('d-none');

        });
    });
</script>

